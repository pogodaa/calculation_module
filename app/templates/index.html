{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - –ú–æ–¥—É–ª—å —Ä–∞—Å—á—ë—Ç–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π{% endblock %}

{% block content %}
<div class="page-header">
    <h2>–†–∞—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</h2>
    <p class="subtitle">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
</div>

<div class="content-grid">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
    <div class="card">
        <h3>üìã –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</h3>
        
        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π -->
        <div class="data-table-container">
            <table class="data-table" id="indicatorsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                        <th>–í–µ—Å</th>
                        <th>–ï–¥. –∏–∑–º.</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="indicatorsBody">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div class="form-group">
            <h4>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å</h4>
            <div class="form-row">
                <input type="text" id="indicatorId" placeholder="–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä" required>
                <input type="number" id="indicatorValue" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" step="0.01" required>
                <input type="number" id="indicatorWeight" placeholder="–í–µ—Å" value="1.0" step="0.1">
                <input type="text" id="indicatorUnit" placeholder="–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è">
                <button type="button" class="btn btn-primary" onclick="addIndicator()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="button-group" style="margin-top: 15px;">
            <button type="button" class="btn btn-secondary" onclick="loadExampleData()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
            <button type="button" class="btn btn-outline" onclick="clearAllIndicators()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            <label class="file-upload-btn">
                <input type="file" id="fileInput" accept=".json,.csv" onchange="uploadFile()" hidden>
                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
            </label>
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∏ —Ä–∞—Å—á—ë—Ç -->
    <div class="card">
        <h3>‚öôÔ∏è –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã</h3>
        
        <form id="calculationForm" method="POST" action="/calculate">
            <!-- –°–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –¥–ª—è –¥–∞–Ω–Ω—ã—Ö -->
            <input type="hidden" id="indicatorsJson" name="indicators_json" value="[]">
            
            <div class="form-group">
                <label for="previousValue">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–¥–ª—è —Ç–µ–º–ø–∞ —Ä–æ—Å—Ç–∞):</label>
                <input type="number" id="previousValue" name="previous_value" step="0.01" placeholder="120000">
            </div>

            <div class="form-group">
                <label for="outputValue">–í—ã—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å):</label>
                <input type="number" id="outputValue" name="output_value" step="0.01" placeholder="540000">
            </div>

            <div class="form-group">
                <label for="inputValue">–í—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å):</label>
                <input type="number" id="inputValue" name="input_value" step="0.01" placeholder="180000">
            </div>

            <div class="button-group" style="margin-top: 20px;">
                <button type="submit" class="btn btn-success btn-large" onclick="prepareFormData()">
                    üöÄ –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞—Å—á—ë—Ç
                </button>
            </div>
        </form>

        <div class="info-box" style="margin-top: 25px;">
            <h4>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
            <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:</p>
            <ul>
                <li>–°—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ</li>
                <li>–°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</li>
                <li>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</li>
                <li>–î–∏—Å–ø–µ—Ä—Å–∏—è</li>
                <li>–ú–µ–¥–∏–∞–Ω–∞</li>
                <li>–¢–µ–º–ø —Ä–æ—Å—Ç–∞ (%)</li>
                <li>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</li>
            </ul>
        </div>
    </div>
</div>

<script>
// –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
let indicators = [];

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è
function addIndicator() {
    const id = document.getElementById('indicatorId').value.trim();
    const value = parseFloat(document.getElementById('indicatorValue').value);
    const weight = parseFloat(document.getElementById('indicatorWeight').value || '1.0');
    const unit = document.getElementById('indicatorUnit').value.trim();
    
    if (!id || isNaN(value)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        return;
    }
    
    indicators.push({
        id: id,
        value: value,
        weight: weight,
        unit: unit
    });
    
    updateTable();
    clearForm();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
function updateTable() {
    const tbody = document.getElementById('indicatorsBody');
    tbody.innerHTML = '';
    
    indicators.forEach((ind, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${ind.id}</td>
            <td>${ind.value.toFixed(2)}</td>
            <td>${ind.weight.toFixed(2)}</td>
            <td>${ind.unit || '-'}</td>
            <td>
                <button type="button" class="btn-sm btn-danger" onclick="removeIndicator(${index})">–£–¥–∞–ª–∏—Ç—å</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è
    document.getElementById('indicatorsJson').value = JSON.stringify(indicators);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è
function removeIndicator(index) {
    indicators.splice(index, 1);
    updateTable();
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
function clearForm() {
    document.getElementById('indicatorId').value = '';
    document.getElementById('indicatorValue').value = '';
    document.getElementById('indicatorWeight').value = '1.0';
    document.getElementById('indicatorUnit').value = '';
}

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
function clearAllIndicators() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏?')) {
        indicators = [];
        updateTable();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
function loadExampleData() {
    indicators = [
        {id: "–ü—Ä–æ–¥–∞–∂–∏_2024", value: 150000, weight: 1.0, unit: "—Ä—É–±."},
        {id: "–ü—Ä–∏–±—ã–ª—å_2024", value: 50000, weight: 1.2, unit: "—Ä—É–±."},
        {id: "–ö–ª–∏–µ–Ω—Ç—ã_2024", value: 1200, weight: 0.8, unit: "—á–µ–ª."},
        {id: "–ó–∞—Ç—Ä–∞—Ç—ã_2024", value: 80000, weight: 0.9, unit: "—Ä—É–±."},
        {id: "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", value: 1.8, weight: 1.5, unit: "–∫–æ—ç—Ñ—Ñ."}
    ];
    updateTable();
}

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
function prepareFormData() {
    document.getElementById('indicatorsJson').value = JSON.stringify(indicators);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
function uploadFile() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/upload-file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            indicators = data.indicators;
            updateTable();
            alert(`–§–∞–π–ª "${data.filename}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω (${indicators.length} –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π)`);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error);
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.onload = function() {
    updateTable();
};
</script>
{% endblock %}